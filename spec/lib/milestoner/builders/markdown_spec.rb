# frozen_string_literal: true

require "dry/monads"
require "spec_helper"

RSpec.describe Milestoner::Builders::Markdown do
  include Dry::Monads[:result]

  using Refinements::Pathname

  subject(:builder) { described_class.new enricher: }

  include_context "with application dependencies"
  include_context "with enriched commit"

  let(:enricher) { instance_double Milestoner::Commits::Enricher, call: Success([commit]) }
  let(:at) { Time.parse("2000-01-01 00:00:00").utc }

  describe "#call" do
    let(:content) { temp_dir.join("index.md").read }

    it "creates root path when missing" do
      temp_dir.delete
      expect(builder.call.exist?).to be(true)
    end

    it "includes label" do
      builder.call(at:)
      expect(content).to include("# Test Label 1.2.3 (2000-01-01)").or include("# Milestoner")
    end

    it "builds Markdown" do
      builder.call(at:)

      expect(content).to include(<<~BODY)
        - ðŸŸ¢ Added documentation - *Zoe Washburne*

        **1 commit. 2 files. 10 deletions. 5 insertions.**
      BODY
    end

    it "includes generator" do
      builder.call(at:)

      expect(content).to include("*Generated by [Test Generator](https://test.com).*")
                     .or include("(https://alchemists.io/projects/milestoner)")
    end

    it "answers build path" do
      expect(builder.call).to eq(temp_dir.join("index.md"))
    end
  end
end
